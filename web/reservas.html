<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.I.G | Reservas</title>
    <link rel="icon" href="src/img/logo.png">
    <link rel="stylesheet" href="src/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script> <!-- ESSENCIAL -->
    <script type="text/javascript" src="src/js/reservas.js"></script>
</head>
<body>
    <div class="wrapper d-flex flex-column min-vh-100">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
            <a class="navbar-brand" href="#">S.I.G</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="main.html">Página Inicial</a></li>
                    <li class="nav-item"><a class="nav-link" href="destinos.html">Destinos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="reservas.html">Reservas</a></li>
                </ul>
                <a href="options.html" class="nav-link text-white"><i class="fas fa-cog fa-lg"></i></a>
            </div>
        </nav>

        <div class="container my-5">
            <h1 class="text-center mb-4">Reserva de Bilhetes de Comboio</h1>
            <div class="card shadow-sm p-4 mx-auto" style="max-width: 600px;">
                <form id="reservaForm">
                    <div class="mb-3">
                        <label for="origem" class="form-label">Origem</label>
                        <div class="input-group">
                            <select class="form-select" id="origem" required>
                                <option selected disabled value="">Escolha uma estação</option>
                                <!-- Opções serão preenchidas dinamicamente ou manualmente -->
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="btnGravarOrigem" title="Ditar Origem">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="destino" class="form-label">Destino</label>
                        <div class="input-group">
                            <select class="form-select" id="destino" required>
                                <option selected disabled value="">Escolha uma estação</option>
                                <!-- Opções serão preenchidas dinamicamente ou manualmente -->
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="btnGravarDestino" title="Ditar Destino">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" required>

                        <label for="hora" class="form-label mt-2">Hora</label>
                        <input type="time" class="form-control" id="hora" required>
                    </div>

                    <div class="mb-3">
                        <label for="passageiros" class="form-label">Número de Passageiros</label>
                        <input type="number" class="form-control" id="passageiros" min="1" max="10" value="1" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-train me-2"></i>Reservar
                    </button>
                </form>
            </div>
        </div>

        <footer class="mt-auto text-center text-muted py-3 small">
            &copy; 2025 - Sistemas de Informação para a Gestão
        </footer>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reservaModalLabel">Confirmar Reserva</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body" id="modalResumoTexto">
            <!-- Conteúdo dinâmico aqui -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmarReservaBtn">Confirmar Reserva</button>
          </div>
        </div>
      </div>
    </div>
</body>
</html>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('reservaForm');

        const hoje = new Date();
        document.getElementById('data').value = hoje.toISOString().split('T')[0];
        const horas = String(hoje.getHours()).padStart(2, '0');
        const minutos = String(hoje.getMinutes()).padStart(2, '0');
        document.getElementById('hora').value = `${horas}:${minutos}`;

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const origem = document.getElementById('origem').value;
            const destino = document.getElementById('destino').value;
            const data = document.getElementById('data').value;
            const hora = document.getElementById('hora').value;
            const passageiros = document.getElementById('passageiros').value;
            const dataHoraStr = `${data}T${hora}`;

            try {
                const nextTrain = await eel.get_next_train(origem, destino, dataHoraStr)();

                if (nextTrain) {
                    const options = {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    const formattedDate = new Date(nextTrain).toLocaleDateString('pt-PT', options);

                    const modalResumo = document.getElementById('modalResumoTexto');
                    modalResumo.innerHTML = `
                        <strong>Origem:</strong> ${origem}<br>
                        <strong>Destino:</strong> ${destino}<br>
                        <strong>Próximo comboio disponível:</strong> ${formattedDate}<br>
                        <strong>Passageiros:</strong> ${passageiros}
                    `;

                    const reservaModal = new bootstrap.Modal(document.getElementById('reservaModal'));
                    reservaModal.show();
                } else {
                    alert("Não há comboios disponíveis para o horário selecionado.");
                }
            } catch (error) {
                console.error("Erro ao processar reserva:", error);
                alert("Ocorreu um erro ao processar a reserva.");
            }
        });

        document.getElementById('confirmarReservaBtn').addEventListener('click', async () => {
            const origem = document.getElementById('origem').value;
            const destino = document.getElementById('destino').value;
            const data = document.getElementById('data').value;
            const hora = document.getElementById('hora').value;
            const dataHoraStr = `${data}T${hora}`;

            try {
                await eel.adicionar_reserva(origem, destino, dataHoraStr)();
                bootstrap.Modal.getInstance(document.getElementById('reservaModal')).hide();
                document.getElementById('reservaForm').reset();
            } catch (error) {
                console.error("Erro ao guardar reserva:", error);
                alert("Erro ao guardar a reserva.");
            }
        });

    });
</script>
